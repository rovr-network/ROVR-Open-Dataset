# Data File Decryption Tool

This is a command-line tool for batch decryption of data files, supporting recursive directory scanning and automatic key matching based on filenames.

## Features

- 🔍 **Recursive Directory Scanning**: Supports multi-level directory structures, automatically scans all encrypted files
- 🔑 **Smart Key Matching**: Automatically extracts key prefix from filename and matches corresponding full key
- 📊 **Progress Display**: Real-time decryption progress display with user-friendly experience
- 🏗️ **Directory Structure Preservation**: Maintains original directory structure after decryption
- 📝 **Error Logging**: Records failed files and detailed error information
- ⚡ **Efficient Processing**: Supports large batch file processing, single file errors don't affect overall process

## Install Dependencies

```bash
pip install -r requirements.txt
```

## Usage

### Basic Usage

```bash
python data_decryptor.py <encrypted_files_directory> <output_directory> <key_file_path>
```

### Parameter Description

- `encrypted_files_directory`: Directory path containing encrypted files, tool will recursively scan all subdirectories
- `output_directory`: Output directory for decrypted files, preserves original directory structure
- `key_file_path`: Text file path containing decryption keys

### Optional Parameters

- `--error-log`: Specify error log file path (auto-generated by default)

### Usage Examples

```bash
# Basic usage
python data_decryptor.py /path/to/encrypted_files /path/to/output /path/to/keys.txt

# Specify error log file
python data_decryptor.py /path/to/encrypted_files /path/to/output /path/to/keys.txt --error-log my_errors.log
```

## File Format Requirements

### Encrypted File Naming Format

Supported file extensions: `.data`, `.gga`

Filename format: `timestamp-deviceID-sequence-keyPrefix.extension`

Examples:
- `20250915053307-1025040007-1-Debq.data`
- `20250916080000-1025040008-2-AbCd.gga`

Where `Debq`, `AbCd` etc. are the first four characters of the file's encryption key.

### Key File Format

The key file is a plain text file containing one 32-character key per line.

Example `keys.txt`:
```
DebqXYZ123456789012345678901234
AbCdEFG789012345678901234567890
1234567890123456789012345678HIJK
# This is a comment line, will be ignored
```

Format requirements:
- One key per line, 32 characters each
- Supports comment lines starting with `#`
- Empty lines are automatically ignored
- First four characters of key used for filename matching

## Decryption Algorithm

The tool uses AES CFB mode for decryption, with key format as a 32-character string:
- First 16 characters as AES key
- Last 16 characters as initialization vector (IV)

This algorithm is consistent with the Go version, ensuring compatibility.

## Output Description

### Console Output

The tool displays during execution:
- ✅ Parameter validation results
- 🔑 Key loading status
- 📁 File scanning results
- 📊 Real-time decryption progress
- 📈 Final statistics

### Error Log

Failed files are recorded in the error log file, containing:
- Timestamp
- Failed file path
- Detailed error reason

Example error log:
```
2024-09-25 10:30:15,123 - File: /path/to/file.data | Error: No corresponding key found, prefix: XyZw
2024-09-25 10:30:16,456 - File: /path/to/file2.gga | Error: Decryption failed: Invalid key length
```

## Directory Structure Example

### Input Directory Structure
```
encrypted_files/
├── 2024-09-01/
│   ├── device_001/
│   │   ├── 20240901100000-1025040001-1-Debq.data
│   │   └── 20240901100030-1025040001-2-Debq.data
│   └── device_002/
│       └── 20240901100000-1025040002-1-AbCd.gga
└── 2024-09-02/
    └── 20240902080000-1025040003-1-XyZw.data
```

### Output Directory Structure (maintains same structure)
```
output_files/
├── 2024-09-01/
│   ├── device_001/
│   │   ├── 20240901100000-1025040001-1-Debq.data
│   │   └── 20240901100030-1025040001-2-Debq.data
│   └── device_002/
│       └── 20240901100000-1025040002-1-AbCd.gga
└── 2024-09-02/
    └── 20240902080000-1025040003-1-XyZw.data
```

## FAQ

### Q: What operating systems does the tool support?
A: Supports Windows, macOS, Linux and all operating systems supported by Python.

### Q: How to handle large numbers of files?
A: The tool is optimized for processing large batches of files, uses progress bars to show processing status, and single file failures don't affect other file processing.

### Q: How many keys can the key file contain?
A: Theoretically no limit, the tool loads all keys into memory to improve lookup efficiency.

### Q: Where are decrypted files saved?
A: Decrypted files are saved to the specified output directory, maintaining the same directory structure as the input directory.

### Q: How to check failed files?
A: Check the automatically generated error log file, or use the `--error-log` parameter to specify the log file location.

## Technical Specifications

- **Development Language**: Python 3.7+
- **Main Dependencies**: pycryptodome, tqdm
- **Encryption Algorithm**: AES CFB mode (128-bit segment)
- **Key Format**: 32-character string (first 16 chars as key + last 16 chars as IV)

## Version History

### v1.0.0
- Initial release
- Support recursive directory scanning
- Implement AES CFB decryption
- Add progress display and error handling
